<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>FedRAMP Controls Search</title>
  <meta name="description" content="View NIST 800-53 and FedRAMP controls by baseline or search by keyword.">
  <meta name="keywords" content="FedRAMP, FISMA, FedRAMP Low, FedRAMP Li-SaaS, FedRAMP Moderate, FedRAMP High, NIST, NIST 800-53, NIST 800-53r4, NIST 800-53r5">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="holiday.css">
</head>

<body>
  <script src="fedramp-controls.js"></script>
  <script src="elasticlunr.js"></script>
  <script>
    elasticlunr.Configuration.prototype.addAllFields2UserConfig = function (bool, expand, fields) {
      fields.forEach(function (field) {
        this.config[field] = {
          boost: 1,
          bool: bool,
          expand: expand
        };
      }, this);
      this.config['search_supertitle'] = {boost: 8, bool: "AND", expand: expand};
      this.config['search_title'] = {boost: 4, bool: "AND", expand: expand};
      this.config['search_supercorpus'] = {boost: 2, bool: "AND", expand: expand};
      this.config['search_corpus'] = {boost: 1, bool: "AND", expand: expand};
    };
    elasticlunr.Configuration.prototype.buildUserConfig = function (config, fields) {
      var global_bool = "AND";
      var global_expand = false;

      this.reset();
      if ('bool' in config) {
        global_bool = config['bool'] || global_bool;
      }

      if ('expand' in config) {
        global_expand = config['expand'] || global_expand;
      }

      if ('fields' in config) {
        for (var field in config['fields']) {
          if (fields.indexOf(field) > -1) {
            var field_config = config['fields'][field];
            var field_expand = global_expand;
            if (field_config.expand != undefined) {
              field_expand = field_config.expand;
            }

            this.config[field] = {
              boost: (field_config.boost || field_config.boost === 0) ? field_config.boost : 1,
              bool: field_config.bool || global_bool,
              expand: field_expand
            };
          } else {
            elasticlunr.utils.warn('field name in user configuration not found in index instance fields');
          }
        }
        this.config['search_supertitle'] = {boost: 8, bool: "AND", expand: global_expand};
        this.config['search_title'] = {boost: 4, bool: "AND", expand: global_expand};
        this.config['search_supercorpus'] = {boost: 2, bool: "AND", expand: global_expand};
        this.config['search_corpus'] = {boost: 1, bool: "AND", expand: global_expand};
      } else {
        this.addAllFields2UserConfig(global_bool, global_expand, fields);
      }
    };
    var index = elasticlunr(function () {
      this.addField('search_supertitle');
      this.addField('search_title');
      this.addField('search_supercorpus');
      this.addField('search_corpus');
      this.setRef('index');
    });
    all_controls.forEach(function(item) {index.addDoc(item);});

    function render_items(items) {
      var result_html = '';
      items.forEach(
        function(item) {
          var baseline_tag = [];
          if (item['baselines'].length == 0) {
            baseline_tag.push('No Baseline');
          }
          if (item['baselines'].includes('LOW')) {
            baseline_tag.push('L');
          }
          if (item['baselines'].includes('MODERATE')) {
            baseline_tag.push('M');
          }
          if (item['baselines'].includes('HIGH')) {
            baseline_tag.push('H');
          }
          var baseline_text = '[' + baseline_tag.join(',') + ']';
          result_html += '<div><h5 class="control_family">'+item['family']+'</h5><h3 class="control_title">'+item['control_id']+' '+item['control_title']+' <small>'+baseline_text+'</small></h3></div>';
          result_html += '<div><h4>Control</h4><blockquote><p>'+item['description']+'</p></blockquote></div>';
          if ('supplemental_guidance' in item) {
            result_html += '<div><h4>Supplemental Guidance</h4><blockquote><p>'+item['supplemental_guidance']+'</p></blockquote></div>';
          }
          if ('fedramp_low_parameter' in item) {
            result_html += '<div><h4>FedRAMP-Defined Parameter, Low</h4><p>'+item['fedramp_low_parameter']+'</p></div>';
          }
          if ('fedramp_low_additional' in item) {
            result_html += '<div><h4>Additional FedRAMP Requirements and Guidance, Low</h4><p>'+item['fedramp_low_additional']+'</p></div>';
          }
          if ('fedramp_moderate_parameter' in item) {
            result_html += '<div><h4>FedRAMP-Defined Parameter, Moderate</h4><p>'+item['fedramp_moderate_parameter']+'</p></div>';
          }
          if ('fedramp_moderate_additional' in item) {
            result_html += '<div><h4>Additional FedRAMP Requirements and Guidance, Moderate</h4><p>'+item['fedramp_moderate_additional']+'</p></div>';
          }
          if ('fedramp_high_parameter' in item) {
            result_html += '<div><h4>FedRAMP-Defined Parameter, High</h4><p>'+item['fedramp_high_parameter']+'</p></div>';
          }
          if ('fedramp_high_additional' in item) {
            result_html += '<div><h4>Additional FedRAMP Requirements and Guidance, High</h4><p>'+item['fedramp_high_additional']+'</p></div>';
          }
          if (item['related'] && item['related'].length > 0) {
            result_html += '<div><h4>Related</h4><p>'+item['related'].join(', ')+'</p></div>';
          }
          result_html += '<hr>';
      });
      return result_html;
    }

    var all_controls_html = '';
    var low_controls_html = '';
    var moderate_controls_html = '';
    var high_controls_html = '';
    function display_baseline_items(baseline) {
      if (baseline == '' || baseline == 'all') {
        if (all_controls_html == '') {
          all_controls_html = render_items(all_controls);
        }
        document.getElementById("results_main").innerHTML = all_controls_html;
      } else if (baseline == 'low') {
        if (low_controls_html == '') {
          low_controls_html = render_items(
            all_controls.filter(function(item) {
              return item['baselines'].includes('LOW');
          }));
        }
        document.getElementById("results_main").innerHTML = low_controls_html;
      } else if (baseline == 'moderate') {
        if (moderate_controls_html == '') {
          moderate_controls_html = render_items(
            all_controls.filter(function(item) {
              return item['baselines'].includes('MODERATE');
          }));
        }
        document.getElementById("results_main").innerHTML = moderate_controls_html;
      } else if (baseline == 'high') {
        if (high_controls_html == '') {
          high_controls_html = render_items(
            all_controls.filter(function(item) {
              return item['baselines'].includes('HIGH');
          }));
        }
        document.getElementById("results_main").innerHTML = high_controls_html;
      }
    }

    function display_items(items) {
      document.getElementById("results_main").innerHTML = render_items(items);
    }

    function display_none() {
      document.getElementById("results_main").innerHTML = '';
    }

    function do_search() {
      var query = document.getElementById("search_field").value;
      var result = index.search(query, {});
      result.sort(function(a, b) {return (b.score - a.score);});
      display_items(result.map(function(ref_item) {
        return all_controls[ref_item['ref']];
      }))
    }
  </script>

  <div style="width:auto; height:auto; padding:0; margin:0; background-color:#3B7D5C; color: white; text-align: center;">Not affiliated with anyone (FedRAMP, FedRAMP PMO, GSA, NIST, US Gov).</div>

  <div id="search_main" style="margin-top:1rem;">
    Show NIST 800-53 (Rev. 4) and FedRAMP controls for
    <a href="#" onclick="display_baseline_items('all'); return false;">[all]</a>,
    <a href="#" onclick="display_baseline_items('low'); return false;">[low]</a>,
    <a href="#" onclick="display_baseline_items('moderate'); return false;">[moderate]</a>,
    <a href="#" onclick="display_baseline_items('high'); return false;">[high]</a> baselines.
    <label for="search_field" style="margin-top:0;">Search in controls:</label>
    <input type="text" id="search_field" name="search_field">
  </div>
  <div id="results_main">
  </div>

  <script>
    // Based on https://stackoverflow.com/a/5926782
    var typingTimer;
    var doneTypingInterval = 10;
    var myInput = document.getElementById('search_field');

    myInput.addEventListener('keyup', () => {
        if (myInput.value) {
          typingTimer = do_search();
        } else {
          display_none();
        }
    });
  </script>
</body>
</html>
